(window.odspNextWebpackJsonp=window.odspNextWebpackJsonp||[]).push([[400,401],{1712:function(e,t,n){"use strict";n.d(t,"e",function(){return o}),n.d(t,"n",function(){return s}),n.d(t,"t",function(){return c}),n.d(t,"a",function(){return d}),n.d(t,"r",function(){return l}),n.d(t,"i",function(){return u});var a=n(40),i=n(31),r=["","Lock","Unlock","Manage","FreDialog","Unlock","Reset","Debug","FilesRemaining"],o="PVault-IconUpsell",s="PVault-QuotaBannerLearnMore",c="PVault-QuotaBannerGoPremium",d="PVault-QuotaErrorLearnMore";function l(e){return r[e]}function u(e,t){var n;switch(e){case a.e.Files:n="Files";break;case a.e.Restore:n="Restore";break;case a.e.RansomwareDetection:n="RansomwareDetection";break;case a.e.ManageVault:n="ManageVault";break;default:n=""}return t?"".concat(n,"-").concat(i.e[t]):"".concat(n)}},1944:function(e,t,n){"use strict";var a=n(0),i=function(e){function t(t){var n=e.call(this,t)||this;return n.html=t.html,n}return Object(a.__extends)(t,e),t}(n(1294).t),r=n(1296).e({tagName:"ms-html-container",template:'<div class="HTMLContainer" data-bind="html:html"></div>',viewModel:i});t.e=r},2349:function(e,t,n){"use strict";n.r(t),n.d(t,"resourceKey",function(){return u});var a=n(0),i=n(1295),r=n(490),o=n(419),s=n(178),c=n(1571),d=n(302),l=function(e){function t(t,n){void 0===t&&(t={});var a=e.call(this,t,n)||this;return a._identityDataSource=n.identityDataSource,a.isVaultDisabled=a.createObservable(void 0),a.vaultFreState=a.createObservable(c.a.NotCreated),a.vaultQuota=a.createObservable(void 0),a.isOverQuota=a.createPureComputed(a._computeIsOverQuota),a.showVaultLockNotification=a.createObservable(!1),a.showVaultFreMessage=a.createObservable(!1),a.storageKeyPrefix=c.t+a._identityDataSource.getIdentity().id,a.dataStore=new o.e(a.storageKeyPrefix,s.e.local),a.isVaultOpen=a.createObservable(!!a.dataStore.getValue("expirationtime",s.e.local)),a}return Object(a.__extends)(t,e),t.prototype._computeIsOverQuota=function(){var e=this.vaultQuota();return!!e&&e.remainingFiles<=0&&e.totalFiles>0},t}(i.n);t.default=l;var u=Object(r.r)("VaultStore",l,Object(a.__assign)(Object(a.__assign)({},i.n.dependencies),{identityDataSource:d.D}))},2465:function(e,t,n){"use strict";n.r(t),n.d(t,"STORAGE_KEY_EXPIRATION",function(){return T}),n.d(t,"resourceKey",function(){return B});var a=n(0),i=n(1295),r=n(178),o=n(302),s=n(128),c=n(1325),d=n(49),l=n(1312),u=n(194),f=n(1427),p=n(1324),m=n(1327),_=n(2349),h=n(1571),b=n(228),g=n(242),v=n(1712),y=n(31),S=n(1302),D=n(1314),I=n(490),x=n(1454),C=n(1418),O=n(1944),w=n(2865),E=n(66),A=n(497),L=n(21),k=n(9),M=n(914),P=n(512),T="expirationtime",U="vaultMenuCalloutMessageShow",F=["ManageVault","Restore","RansomwareDetection"],H=!L.e.isActivated("CD980492-57E1-4F11-95BA-27FBECF1987D","01/25/2022","Enable item invalidate after vault actions in ODC lightspeed"),R=!L.e.isActivated("41127D76-546C-4B0D-A56E-271886E91F4A","02/18/2022","Enable quota invaludate in ODC lightspeed when needed"),N=function(e){function t(t,n){void 0===t&&(t={});var a=e.call(this,t,n)||this;return a._clientName=n.clientName,a._identityDataSource=n.identityDataSource,a._vroomDataRequestor=n.vroomDataRequestor,a._itemStore=n.itemStore,a._navigation=n.navigation,a._urlDataSource=n.urlDataSource,a._itemProvider=n.itemProvider,a._dialogProvider=n.dialogProvider,a._userInfoProvider=n.userInfoProvider,a._itemParentHelper=n.itemParentHelper,a._bundleLoader=n.bundleLoader,a._isItemsScopeEnabled=n.isItemsScopeEnabled,a._vaultStore=n.vaultStore,a._storageKeyPrefix=a._vaultStore.storageKeyPrefix,a._dataStore=a._vaultStore.dataStore,a._isVaultOpen=a._vaultStore.isVaultOpen,a._vaultFreState=a._vaultStore.vaultFreState,a._vaultSuggestCardState=a.createObservable(0),a._vaultQuota=a._vaultStore.vaultQuota,a._quotaLoaded=a.createComputed(a._computeQuotaLoaded),a._isVaultDisabled=a._vaultStore.isVaultDisabled,a._isLocking=!1,a._isOneDriveWinApp=Object(A.e)(),a.isOverQuota=a._vaultStore.isOverQuota,a._showVaultLockNotification=a._vaultStore.showVaultLockNotification,a._showVaultFreMessage=a._vaultStore.showVaultFreMessage,a.createComputed(a._calculateFreMessage),a.events.on(window,"storage",a._onStorageChange),a.createBackgroundComputed(a._updateVaultQuota),a.fetchIsVaultDisabled(),a._isVaultOpen.peek()&&(a._getExpiration()<Date.now()?a.lockVault(void 0,!0):a._handleVaultUnlock()),a}return Object(a.__extends)(t,e),t.prototype.vaultLockMessageSubscribe=function(e){this.scope.attach(e.register(this._showVaultLockNotification))},t.prototype.vaultStateSubscribe=function(e){this.scope.attach(e.register(this._isVaultOpen))},t.prototype.vaultFreSubscribe=function(e){this.scope.attach(e.register(this._vaultFreState))},t.prototype.vaultQuotaSubscribe=function(e){this.scope.attach(e.register(this._vaultQuota))},t.prototype.vaultMenuCalloutSubscribe=function(e){this.scope.attach(e.register(this._showVaultFreMessage))},t.prototype.vaultDisabledSubscribe=function(e){this.scope.attach(e.register(this._isVaultDisabled))},t.prototype.getVaultItem=function(){return this._vaultItem},t.prototype.isVaultOpen=function(){return this._isVaultOpen},t.prototype.isVaultDisabled=function(){return this._isVaultDisabled},t.prototype.freState=function(){return this._vaultFreState},t.prototype.suggestCardState=function(){return this._vaultSuggestCardState},t.prototype.getShowVaultFreMessage=function(){return this._showVaultFreMessage()},t.prototype.setShowVaultFreMessage=function(e,t){void 0===t&&(t=!1),t||this._showVaultFreMessage(e),this._setVaultIconFre(e)},t.prototype.unlockVault=function(e,t){var n=this;return this.getVault(!1,!0).then(function(i){if(!i||!i.vault||i.vault.isLocked||e){var r;r=e?n._identityDataSource.getSessionToken(!0):n._isOneDriveWinApp?g.n.resolve({wlidToken:t}):g.n.resolve({accessToken:t});var o={};return n._isOneDriveWinApp&&(o.Prefer="Include-Feature=Vault"),Object(k._r)(k.i)&&(o=Object(a.__assign)(Object(a.__assign)(Object(a.__assign)({},o),{Scenario:P.e.OpenVault,ScenarioType:P.t.ActiveUserOperation}),n._clientName?{Application:n._clientName}:{})),r.then(function(t){return n._vroomDataRequestor.send({apiName:"action.unlockVault",path:"/drive/special/vault/action.unlockVault",headers:o,requestType:"POST",postData:JSON.stringify({}),accessToken:t,postProcessQos:n._postProcessUnlockQos.bind(n),useAuthorizationHeaders:!0,qosExtraData:{isExtend:!!e}}).then(function(){if(n.setVaultLockState({root:void 0,isLocked:!1,expirationInSeconds:1200}),!e){var t=n._urlDataSource.getRootItemKey();n._invalidateItems(t)}return g.n.resolve({})}).catch(function(e){return n._handleVaultLock(),g.n.reject(e)})})}n.setVaultLockState(i.vault,!!t)})},t.prototype.setVaultLockState=function(e,t,n){if(void 0===t&&(t=!1),!this._isLocking){var a=this._isVaultOpen.peek(),i=e.isLocked;if(i||a)i&&a&&this._handleVaultLock(!1,n);else{var o=e.expirationInSeconds||1200,s=Date.now()+1e3*o;this._dataStore.setValue(T,s,r.e.local),this._handleVaultUnlock(t)}}},t.prototype.lockVault=function(e,t){var n=this;if(this._isLocking=!0,this._navToRootIfInVault(),e){var i=this._urlDataSource.getPageType(this._navigation.viewParams),r=this._urlDataSource.getQueryType(this._navigation.viewParams);s.e.logData({name:"Vault.Autolocked",extraData:{location:Object(v.i)(i,r)}})}var o=this._vaultItem?g.n.resolve(this._vaultItem):this.getVault(),c={};return this._isOneDriveWinApp&&(c.Prefer="Include-Feature=Vault"),Object(k._r)(k.i)&&(c=Object(a.__assign)(Object(a.__assign)(Object(a.__assign)({},c),{Scenario:P.e.CloseVault,ScenarioType:P.t.ActiveUserOperation}),this._clientName?{Application:this._clientName}:{})),o.then(function(a){return n._vroomDataRequestor.send({apiName:"action.lockVault",path:"/drive/special/vault/action.lockVault",headers:c,requestType:"POST",postData:JSON.stringify({}),postProcessQos:n._postProcessQos.bind(n),qosExtraData:{isAutoLock:!!e}}).then(function(){n._isLocking=!1,n._handleVaultLock(t)}).catch(function(e){return n._isLocking=!1,403===e.status?n._handleVaultLock(t):n._showLockFailed(),n._isExpectedError(e)?g.n.resolve():g.n.reject(e)})})},t.prototype.dismissLockNotification=function(){this._showVaultLockNotification(!1)},t.prototype.extendLock=function(){return this.unlockVault(!0)},t.prototype.getVault=function(e,t,n,a){var i=this,r={};return e&&(r.Prefer="auto-create-special-folder"),this._isOneDriveWinApp&&(r.Prefer=r.Prefer+",Include-Feature=Vault"),n=n||"GET",this._vroomDataRequestor.send({apiName:a?"EnableVault":e?"CreateVault":"GetVault",path:"/drive/special/vault",headers:r,requestType:n,breakCache:!0,qosExtraData:{requestType:n},postProcessQos:this._postProcessQos.bind(this)}).then(function(e){var t,n;return e&&((null===(n=null===(t=null==e?void 0:e.createdBy)||void 0===t?void 0:t.user)||void 0===n?void 0:n.id)&&(e.createdBy.user.id=e.createdBy.user.id.toUpperCase()),i._vaultItem=e),e}).catch(function(e){return t?null:g.n.reject(e)})},t.prototype.getQuota=function(){var e=this,t={};return this._isOneDriveWinApp&&(t.Prefer="Include-Feature=Vault"),this._vroomDataRequestor.send({apiName:"drive",path:"/drive?select=quota/vault",headers:t,requestType:"GET"}).then(function(t){var n=t&&t.quota&&t.quota.vault;return e._vaultQuota(n),n})},t.prototype.createVaultIfNotExist=function(){var e=this;return this._userInfoProvider.getUserFact(46).then(function(t){if(!t||e._vaultFreState.peek()===h.a.Created)return e.getVault(!0).then(function(t){e.setVaultState(h.a.Created),e._isVaultDisabled(!1);var n=e._urlDataSource.getRootItemKey();return e._invalidateItems(n,{triggerFetch:!0}),t});var n=JSON.parse(t.param||"{}");e._vaultFreState(n.s),e._vaultSuggestCardState(n.c)})},t.prototype.fetchIsVaultDisabled=function(){var e=this;return void 0!==this._isVaultDisabledPromise||(this._isVaultDisabledPromise=this._userInfoProvider.getUserFact(46).then(function(t){return t?e.getVault(!1,!1,"HEAD").then(function(){return e._isVaultDisabled(!1),!1}).catch(function(t){var n=404===t.status;return e._isVaultDisabled(n),n}):(e._isVaultDisabled(!0),!0)})),this._isVaultDisabledPromise},t.prototype.enableVault=function(){var e=this;return this.getVault(!0,!1,"GET",!0).then(function(t){var n=e._urlDataSource.getRootItemKey();return e._invalidateItems(n,{triggerFetch:!0}),e._isVaultDisabled(!1),t})},t.prototype.disableVault=function(e){var t=this,n={};return e&&(n.If="(<".concat(e,">)")),this._isOneDriveWinApp&&(n.Prefer="Include-Feature=Vault"),this._vroomDataRequestor.send({apiName:"deleteVault",headers:n,path:"/drive/special/vault",requestType:"DELETE",postData:JSON.stringify({}),postProcessQos:this._postProcessQos.bind(this)}).then(function(){t._cleanLocalLockInfo(),t._isVaultDisabled(!0)}).catch(function(e){var t=e.response;if(t&&t.error&&t.error.fixItUrl){var n=new E.t(t.error.fixItUrl).getQueryParameter("confirmationToken");if(n)return n}return g.n.reject(e)})},t.prototype.setVaultState=function(e,t){var n=void 0;void 0!==e&&e>this._vaultFreState.peek()&&(this._vaultFreState(e),n=e),t&&this._vaultSuggestCardState(t);var a={s:n||this._vaultFreState.peek(),c:t||this._vaultSuggestCardState.peek()};return this._userInfoProvider.setUserInfo(46,3,JSON.stringify(a))},t.prototype.reset=function(){return g.n.resolve(!1)},t.prototype.toggleDebug=function(){},t.prototype._onNavigationChange=function(){var e=this._getCurrentItem(),t=this._navigation.viewParams,n=this._isVaultOpen.peek();e&&(n&&(!e.vault&&F.indexOf(t&&t.v)<=-1?this._detatchIdleEvents():this._attachIdleEvents()),e.vault&&e.vault.root?this._vaultRootLoadEventFiled||(s.e.logData({name:"Vault.Unlocked.Loaded"}),this._vaultRootLoadEventFiled=!0):this._vaultRootLoadEventFiled=!1)},t.prototype._computeQuotaLoaded=function(){return!!this._bundleLoader.getBundleInfo(2).isLoaded()&&(this._userStateProvider||(this._userStateProvider=this.resources.consume(S.v)),!0)},t.prototype._updateVaultQuota=function(){var e=this._userStateProvider&&this._userStateProvider.quotaNeedsUpdate();if(this._quotaLoaded()&&e&&this._isVaultOpen()&&(this.getQuota(),k.hr&&R)){var t=this._getCurrentItem();this.resources.consumeAsync(o.k).then(function(e){e.invalidateQuota(null==t?void 0:t.key)})}},t.prototype._isDebug=function(){return!1},t.prototype._getExpiration=function(){return this._isDebug()?Date.now()+12e4:this._dataStore.getValue(T,r.e.local)},t.prototype._startExpirationTimers=function(){var e=this;this._expirationWarningTimerId=this.async.setTimeout(function(){e._verifyLockExpiration()},this._getExpiration()-Date.now()-6e4),this._expirationLockTimerId=this.async.setTimeout(function(){e.lockVault(!0)},this._getExpiration()-Date.now())},t.prototype._stopExpirationTimers=function(){this.async.clearTimeout(this._expirationWarningTimerId),this.async.clearTimeout(this._expirationLockTimerId)},t.prototype._resetExpirationTimers=function(){this._stopExpirationTimers(),this._startExpirationTimers()},t.prototype._attachIdleEvents=function(){this._idleEventsAttached||("ontouchstart"in document.documentElement&&this.events.on(document,"touchstart",this._resetLastActivity,!0),this.events.on(document,"mousemove",this._resetLastActivity,!0),this.events.on(document,"keypress",this._resetLastActivity,!0),this._idleEventsAttached=!0)},t.prototype._detatchIdleEvents=function(){this._idleEventsAttached&&("ontouchstart"in document.documentElement&&this.events.off(document,"touchstart",this._resetLastActivity,!0),this.events.off(document,"mousemove",this._resetLastActivity,!0),this.events.off(document,"keypress",this._resetLastActivity,!0),this._idleEventsAttached=!1)},t.prototype._resetLastActivity=function(){this._lastActivity=Date.now()},t.prototype._verifyLockExpiration=function(){var e=this;this._isDebug()?this._showLockWarning():Date.now()-this._lastActivity<9e5?this.extendLock().then(function(){e._resetExpirationTimers()}):this.getVault().then(function(t){var n=t.vault&&t.vault.expirationInSeconds||0;if(1e3*n>12e4){var a=Date.now()+1e3*n;e._dataStore.setValue(T,a,r.e.local),e._resetExpirationTimers()}else e._showLockWarning()}).catch(function(t){return e.lockVault()})},t.prototype._showLockFailed=function(){var e=this,t=this._dialogProvider.requestDialog({title:w.r,component:{name:O.e.tagName,params:{html:'<span class="ms-fontColor-error">'.concat(w.a,"</span>")}},actions:[{name:w.i,execute:function(){return g.n.resolve(2)},isAvailable:this.observables.create(!0),icon:new l.e("CheckMark"),isDefault:!0}],isSoftDismissable:!1});t.wait().then(function(){2===t.state.peek()&&(e.async.clearTimeout(e._retryLockVault),e._retryLockVault=e.async.setTimeout(function(){e.lockVault()},500))})},t.prototype._showLockWarning=function(){var e=this;this._warningDialog=this._dialogProvider.requestDialog({title:w.n,component:{name:C.e.tagName,params:{text:w.e}},actions:[{name:w.t,execute:function(){return s.e.logData({name:"Vault.StillHere.Extend"}),e.extendLock().then(function(){return e._resetExpirationTimers(),g.n.resolve(2)})},isAvailable:this.observables.create(!0),icon:new l.e("Cancel"),isDefault:!0}],isSoftDismissable:!1}),s.e.logData({name:"Vault.StillHere.Shown"}),this._warningDialog.wait().catch(function(){3===e._warningDialog.state.peek()&&s.e.logData({name:"Vault.StillHere.Dismiss"})})},t.prototype._handleVaultLock=function(e,t){this._cleanLocalLockInfo(t),this._showVaultLockNotification(!e)},t.prototype._cleanLocalLockInfo=function(e){var t=this;this._isVaultOpen(!1),this._dataStore.remove(T,r.e.local),this._stopExpirationTimers(),e||this._navToRootIfInVault(),this.events.off(this._navigation,"change",this._onNavigationChange),this._navEventAttached=!1,this._getVaultIconFre()||this._showVaultFreMessage(!1),this._detatchIdleEvents(),this._warningDialog&&this._warningDialog.dismiss(),Object.keys(y.e).map(function(e){var n=t._urlDataSource.getRootItemKey(y.e[e]);t._invalidateItems(n)});var n=this._getCurrentItem();if(this.unwrapObservable(this._itemParentHelper.getFacetedAncestorOrSelf(n,"vault"))){var a=this._urlDataSource.getRootItemKey();this._itemStore.emptyAllOtherSets([a])}else n&&this._invalidateItems(n.key,{emptyAllOtherSets:!0});this._itemStore.invalidateAllVault()},t.prototype._navToRootIfInVault=function(){var e=this._getCurrentItem();if(this.unwrapObservable(this._itemParentHelper.getFacetedAncestorOrSelf(e,"vault"))){var t=this._urlDataSource.getRootItemKey(),n=this._urlDataSource.getItemUrl(t);this._navigation.navigateTo({url:n})}},t.prototype._invalidateItems=function(e,t){var n=this;this._isItemsScopeEnabled()?this.resources.consumeAsync(o.k).then(function(a){a.invalidateItems(e),k.hr&&H&&n._itemProvider.invalidateItem(e,t);var i=n._getCurrentItem();(null==i?void 0:i.vault)&&a.invalidateItems(i.key)}):this._itemProvider.invalidateItem(e,t)},t.prototype._handleVaultUnlock=function(e){var t=this;void 0===e&&(e=!1),this._isVaultOpen(!0),this._resetExpirationTimers();var n=this._urlDataSource.getRootItemKey();this._invalidateItems(n,{triggerFetch:!0}),this._navEventAttached||(this.events.on(this._navigation,"change",this._onNavigationChange),this._navEventAttached=!0,this._onNavigationChange()),this.getQuota(),this._warningDialog&&this._warningDialog.dismiss();var a=this._getCurrentItem();if(a&&(a.vault||a.isPlaceholder||a.error&&a.error.data&&161===a.error.data.errorCode||a.queryType===y.e.RecycleBin&&"root"===a.id)){this._invalidateItems(a.key,{triggerFetch:!0});var i=this._urlDataSource.getFocusItemKey(this._navigation.viewParams);i&&this._invalidateItems(i,{purgeCache:!0})}this._showVaultLockNotification(!1),s.e.logData({name:"Vault.Unlocked.Succeeded"}),this._getVaultIconFre()&&!e&&(this.async.setTimeout(function(){t._showVaultFreMessage(!0)},5e3),this._setVaultIconFre(!1))},t.prototype._onStorageChange=function(e){var t=e.key,n=e.oldValue,a=e.newValue;if(t===this._storageKeyPrefix+h.e&&a)try{var i=JSON.parse(a);FilesConfig.canary!==i&&(FilesConfig.canary=FilesConfig.navCanary=i)}catch(e){}t===this._storageKeyPrefix+T&&(a?(!n||a>n)&&(this._dataStore.getValue(T,r.e.local)||this._dataStore.setValue(T,parseInt(a,10),r.e.local),this._handleVaultUnlock()):this._isVaultOpen.peek()&&this._handleVaultLock())},t.prototype._calculateFreMessage=function(){var e=this;this._getVaultIconFre()&&this.async.setTimeout(function(){e._showVaultFreMessage(!0)},5e3)},t.prototype._getCurrentItem=function(){var e=this._urlDataSource.getCurrentItemKey(this._navigation.viewParams);return this.unwrapObservable(this._itemStore.getItem(e))},t.prototype._getVaultIconFre=function(){return this._dataStore.getValue(U,r.e.local)},t.prototype._setVaultIconFre=function(e){e?this._dataStore.setValue(U,e,r.e.local):this._dataStore.remove(U,r.e.local)},t.prototype._postProcessQos=function(e,t){return this._isExpectedError(t)&&(e.resultType=d.e.ExpectedFailure),e},t.prototype._postProcessUnlockQos=function(e,t){return this._isExpectedUnlockError(t)&&(e.resultType=d.e.ExpectedFailure),e},t.prototype._isExpectedError=function(e){if(400===e.status||403===e.status){var t=Object(u.i)(e);if("memberdoesnotexist"===(t=t&&t.toLowerCase())||"unlockrequired"===t||"accessdenied"===t||"confirmationrequired"===t)return!0}else if(404===e.status)return!0;return!1},t.prototype._isExpectedUnlockError=function(e){var t=Object(u.i)(e);return"vaultunlockextensiontimeexceeded"===(t=t&&t.toLowerCase())&&(s.e.logData({name:"Vault.Unlock.MaxExtensionError"}),!0)},t}(i.n);t.default=N;var B=Object(I.r)("VaultDataSource",N,Object(a.__assign)(Object(a.__assign)({},i.n.dependencies),{clientName:M.e.optional,identityDataSource:o.D,vroomDataRequestor:x.e,itemStore:p.e,vaultStore:_.resourceKey,urlDataSource:o.ge,navigation:b.e,itemProvider:D.resourceKey,dialogProvider:c.e,userInfoProvider:S.k,itemParentHelper:f.e,bundleLoader:S.e,isItemsScopeEnabled:m.u.lazy}))}}]);